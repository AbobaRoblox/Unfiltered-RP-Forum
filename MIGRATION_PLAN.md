# План перехода на реальный сервер (реальное время)

## Текущая ситуация

**Сейчас:**
- Все данные хранятся в LocalStorage браузера
- API запросы эмулируются локально (handleLogin, handleRegister и т.д.)
- Каждый пользователь видит только свои данные
- Нет синхронизации между пользователями
- Нет реального времени

**Цель:**
- Все данные хранятся на сервере (MySQL)
- API запросы идут на реальный сервер (server-mysql.js)
- Все пользователи видят одинаковые данные
- Реальное время через WebSocket/Socket.io (опционально)

## Этап 1: Базовое переключение API (ТЕКУЩИЙ ЭТАП)

### Задачи:
1. ✅ Создать функцию для определения режима работы (реальный сервер / локальный)
2. ✅ Изменить функцию `api.request()` для работы с реальным сервером
3. ✅ Добавить базовый URL сервера (можно настраивать)
4. ✅ Обработка ошибок сети
5. ✅ Сохранение токена авторизации

### Что нужно изменить:
- `script.js`: функция `api.request()` 
- Добавить настройку `API_BASE_URL` (можно через переменную или localStorage)
- Добавить fallback на локальный режим при ошибках

### Файлы для изменения:
- `script.js` (функция api.request)

## Этап 2: Тестирование базового API

### Задачи:
1. Проверить авторизацию/регистрацию
2. Проверить получение постов
3. Проверить создание постов
4. Проверить комментарии
5. Проверить админ-панель

### Тесты:
- Регистрация нового пользователя
- Вход в систему
- Создание темы
- Просмотр тем
- Добавление комментариев

## Этап 3: Синхронизация данных

### Задачи:
1. Убрать LocalStorage DB полностью (или оставить только для кэширования)
2. Все операции с данными идут через API
3. Добавить индикаторы загрузки
4. Обработка ошибок сети

### Что нужно изменить:
- Удалить все вызовы `DB.get()`, `DB.insert()`, `DB.update()`, `DB.delete()`
- Заменить на `api.get()`, `api.post()`, `api.put()`, `api.delete()`
- Добавить обработку ошибок на каждом запросе

## Этап 4: Реальное время (опционально, но желательно)

### Что такое Socket.io?
Socket.io — библиотека для работы в реальном времени. Позволяет серверу отправлять данные браузеру мгновенно, без постоянных запросов.

**Примеры:**
- Новый комментарий появляется сразу у всех (без обновления страницы)
- Мут пользователя работает мгновенно
- Уведомления приходят сразу
- Онлайн пользователи обновляются автоматически

Подробнее смотрите файл `SOCKET_IO_EXPLANATION.md`

### Задачи:
1. Установить Socket.io на сервере (`npm install socket.io`)
2. Подключить Socket.io на клиенте (через CDN или npm)
3. Реализовать события:
   - Новый пост → `post_created`
   - Новый комментарий → `comment_created`
   - Новое сообщение → `message_created`
   - Обновление статуса поста → `post_status_changed`
   - Мут/бан пользователя → `user_muted`, `user_banned`
   - Онлайн пользователи → `user_online`, `user_offline`

### Файлы для изменения:
- `server-mysql.js` (добавить Socket.io)
- `script.js` (подключить клиент Socket.io)
- `index.html` (добавить скрипт Socket.io)
- `package.json` (добавить socket.io)

## Этап 5: Оптимизация

### Задачи:
1. Кэширование данных (опционально)
2. Оптимизация запросов
3. Lazy loading
4. Бесконечная прокрутка

## Детальный план изменений

### 1. script.js - api.request()

**Было:**
```javascript
async request(endpoint, options = {}) {
    // Simulate async operation
    await new Promise(resolve => setTimeout(resolve, 0));
    
    const method = options.method || 'GET';
    const body = options.body ? JSON.parse(options.body) : null;
    const url = new URL(endpoint, 'http://localhost');
    
    try {
        // Route handling - все локально
        if (endpoint.startsWith('/auth/login') && method === 'POST') {
            return this.handleLogin(body);
        }
        // ... остальные обработчики
    } catch (error) {
        throw error;
    }
}
```

**Стало:**
```javascript
async request(endpoint, options = {}) {
    const USE_REAL_SERVER = localStorage.getItem('useRealServer') === 'true' || true; // по умолчанию true
    const API_BASE_URL = localStorage.getItem('apiBaseUrl') || 'https://unfilteredrp-forum.ru'; // или ваш домен
    
    if (!USE_REAL_SERVER) {
        // Старая логика для локального режима (для тестирования)
        return this.localRequest(endpoint, options);
    }
    
    const method = options.method || 'GET';
    const url = `${API_BASE_URL}${endpoint}`;
    
    try {
        const fetchOptions = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            }
        };
        
        if (this.token) {
            fetchOptions.headers['Authorization'] = `Bearer ${this.token}`;
        }
        
        if (options.body) {
            fetchOptions.body = options.body;
        }
        
        const response = await fetch(url, fetchOptions);
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: 'Network error' }));
            throw new Error(errorData.message || `HTTP ${response.status}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error('API Error:', error);
        throw error;
    }
}
```

### 2. Настройка сервера

Убедиться, что `server-mysql.js`:
- ✅ Принимает CORS запросы
- ✅ Правильно обрабатывает Authorization заголовок
- ✅ Все эндпоинты работают
- ✅ Возвращает правильный JSON

### 3. Постепенная миграция

Можно сделать переключатель режима работы:
- Локальный режим (для разработки/тестирования)
- Реальный сервер (для продакшена)

## Важные замечания

1. **Токены авторизации:**
   - На сервере нужно использовать JWT или сессии
   - Сейчас используется простой токен `token_${userId}`
   - Нужно синхронизировать логику токенов между клиентом и сервером

2. **Обработка ошибок:**
   - Все API запросы должны обрабатывать ошибки сети
   - Показывать понятные сообщения пользователю
   - Fallback на локальный режим при недоступности сервера (опционально)

3. **Производительность:**
   - Добавить индикаторы загрузки
   - Кэширование данных (опционально)
   - Оптимизировать количество запросов

4. **Безопасность:**
   - Все пароли должны хешироваться на сервере (не на клиенте!)
   - Использовать HTTPS
   - Валидация данных на сервере

## Порядок реализации

1. ✅ **Этап 1**: Базовое переключение API (СЕЙЧАС)
2. ⏳ **Этап 2**: Тестирование
3. ⏳ **Этап 3**: Полная миграция данных
4. ⏳ **Этап 4**: Реальное время (Socket.io)
5. ⏳ **Этап 5**: Оптимизация

## Команды для тестирования

После реализации базового переключения:

```bash
# 1. Убедиться, что сервер запущен
node server-mysql.js

# 2. Открыть сайт в браузере
# 3. Открыть консоль разработчика (F12)
# 4. Проверить Network tab - должны быть запросы к серверу
# 5. Проверить Console - не должно быть ошибок
```

## Откат (если что-то пойдет не так)

Если нужно вернуться к локальному режиму:
```javascript
localStorage.setItem('useRealServer', 'false');
// Перезагрузить страницу
```

Или в коде:
```javascript
const USE_REAL_SERVER = false; // вместо true
```

